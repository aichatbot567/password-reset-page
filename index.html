<!DOCTYPE html>
<html>
<head>
    <title>Password Reset</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 500px; margin: 0 auto; padding: 20px; }
        .container { background: #f8f9fa; padding: 30px; border-radius: 8px; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #4BA1AE; color: white; border: none; padding: 12px; width: 100%; border-radius: 4px; }
        .error { color: red; margin-top: 10px; }
        .success { color: green; margin-top: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Reset Password</h2>
        <div id="loading">Loading...</div>
        
        <form id="resetForm" class="hidden">
            <input type="password" id="password" placeholder="New password" required minlength="8">
            <input type="password" id="confirmPassword" placeholder="Confirm password" required minlength="8">
            <button type="submit">Update Password</button>
            <div id="error" class="error hidden"></div>
        </form>
        
        <div id="success" class="success hidden">
            Password updated successfully! You can now close this page.
        </div>
        
        <div id="invalid" class="error hidden">
            Invalid or expired reset link. Please request a new one.
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.hash.substring(1));
            const token = urlParams.get('access_token');
            const type = urlParams.get('type');
            
            const loading = document.getElementById('loading');
            const form = document.getElementById('resetForm');
            const success = document.getElementById('success');
            const invalid = document.getElementById('invalid');
            const error = document.getElementById('error');
            
            if (type === 'recovery' && token) {
                loading.classList.add('hidden');
                form.classList.remove('hidden');
                
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const password = document.getElementById('password').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    if (password !== confirmPassword) {
                        error.textContent = 'Passwords do not match';
                        error.classList.remove('hidden');
                        return;
                    }
                    
                    try {
                        const response = await fetch('https://lwzbmsrhcaigmakugjlh.supabase.co/auth/v1/user', {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3emJtc3JoY2FpZ21ha3VnamxoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMwODU1ODcsImV4cCI6MjA1ODY2MTU4N30.YZznPrsmuU4o9mo4F0ixCBW_VtRdpFIysfH0Qh4XxDo',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ password })
                        });
                        
                        if (!response.ok) throw new Error('Failed to update password');
                        
                        form.classList.add('hidden');
                        success.classList.remove('hidden');
                    } catch (err) {
                        error.textContent = err.message;
                        error.classList.remove('hidden');
                    }
                });
            } else {
                loading.classList.add('hidden');
                invalid.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
