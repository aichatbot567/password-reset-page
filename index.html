<!DOCTYPE html>
<html>
<head>
    <title>Reset Password</title>
    <style>
        /* Your existing styles */
    </style>
</head>
<body>
    <div class="container">
        <h2>Reset Your Password</h2>
        <div id="loading">Loading...</div>
        <div id="message" class="hidden"></div>
        <div id="resetForm" class="hidden">
            <div class="form-group">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" required minlength="8">
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <input type="password" id="confirmPassword" required minlength="8">
            </div>
            <button id="submitBtn">Update Password</button>
            <div id="error" class="error hidden"></div>
        </div>
    </div>

    <!-- Load Supabase JS first -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase client immediately
        const supabaseUrl = 'https://lwzbmsrhcaigmakugjlh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3emJtc3JoY2FpZ21ha3VnamxoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NzU0NjMsImV4cCI6MjA1MDU1MTQ2M30.BKVnV_qo0qxfTI68mYmhF3mYn-qnVe2v_JXFMuzeAnw'; // Replace with your actual anon key
        
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            const loadingDiv = document.getElementById('loading');
            const messageDiv = document.getElementById('message');
            const resetForm = document.getElementById('resetForm');
            const errorDiv = document.getElementById('error');
            
            // Parse URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const accessToken = urlParams.get('access_token');
            const type = urlParams.get('type');
            const error = urlParams.get('error');

            async function handleReset() {
                try {
                    if (error) {
                        const errorDesc = decodeURIComponent(error) || 'Invalid or expired link';
                        showMessage(`Error: ${errorDesc}`, false);
                        return;
                    }

                    if (type === 'recovery' && accessToken) {
                        // Set session with the token
                        const { error: authError } = await supabase.auth.setSession({
                            access_token: accessToken,
                            refresh_token: urlParams.get('refresh_token') || ''
                        });
                        
                        if (authError) throw authError;
                        
                        // Show the form
                        showMessage('Please set your new password:', true);
                        setupFormHandlers();
                    } else {
                        throw new Error('Invalid password reset link');
                    }
                } catch (error) {
                    showMessage(`Error: ${error.message}`, false);
                    console.error('Reset error:', error);
                } finally {
                    loadingDiv.style.display = 'none';
                }
            }

            function showMessage(message, showForm) {
                messageDiv.textContent = message;
                messageDiv.style.display = 'block';
                resetForm.style.display = showForm ? 'block' : 'none';
            }

            function setupFormHandlers() {
                document.getElementById('submitBtn').addEventListener('click', async () => {
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    errorDiv.textContent = '';
                    errorDiv.style.display = 'none';
                    
                    if (newPassword !== confirmPassword) {
                        showError('Passwords do not match');
                        return;
                    }
                    
                    if (newPassword.length < 8) {
                        showError('Password must be at least 8 characters');
                        return;
                    }
                    
                    try {
                        // Update password
                        const { error: updateError } = await supabase.auth.updateUser({
                            password: newPassword
                        });
                        
                        if (updateError) throw updateError;
                        
                        showMessage('Password updated successfully!', false);
                    } catch (error) {
                        showError(error.message);
                    }
                });
            }

            function showError(message) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }

            // Start the process
            handleReset();
        });
    </script>
</body>
</html>
